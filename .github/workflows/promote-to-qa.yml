name: Promote to QA

on:
  push:
    paths:
      - '.github/workflows/promote-to-qa.yml'
  workflow_dispatch:

jobs:
  promote-to-qa:
    name: Promote Latest DEV Release Bundle to QA
    runs-on: ubuntu-latest
    
    steps:
    - name: Setup JFrog CLI
      uses: jfrog/setup-jfrog-cli@v4
      with:
        version: latest
      env:
        JF_URL: ${{ vars.JF_URL }}
        JF_USER: ${{ vars.JF_USER }}
        JF_ACCESS_TOKEN: ${{ secrets.JF_ACCESS_TOKEN }}
    
    - name: Get latest DEV release bundle version
      id: get-latest-dev-version
      run: |
        # Fetch promotion records from Artifactory API
        PROMOTION_RESPONSE=$(curl -s -X GET \
          -H "Authorization: Bearer ${{ secrets.JF_ACCESS_TOKEN }}" \
          "${{ vars.JF_URL }}/lifecycle/api/v2/promotion/records/quotopia")
        
        if [ $? -ne 0 ]; then
          echo "Error: Failed to fetch promotion records from Artifactory"
          exit 1
        fi
        
        # Extract the latest DEV release bundle version using jq
        # Filter for environment "DEV", sort by "created" field in descending order, and get the first one
        LATEST_DEV_VERSION=$(echo "$PROMOTION_RESPONSE" | \
          jq -r '.promotions | map(select(.environment == "DEV")) | sort_by(.created) | reverse | .[0].release_bundle_version')
        
        if [ -z "$LATEST_DEV_VERSION" ] || [ "$LATEST_DEV_VERSION" = "null" ]; then
          echo "Error: Could not find latest DEV release bundle version"
          echo "Response: $PROMOTION_RESPONSE"
          exit 1
        fi
        
        echo "latest_dev_version=$LATEST_DEV_VERSION" >> $GITHUB_OUTPUT
        echo "Found latest DEV release bundle version: $LATEST_DEV_VERSION"
        
        # Also extract the created timestamp for reference
        LATEST_DEV_CREATED=$(echo "$PROMOTION_RESPONSE" | \
          jq -r '.promotions | map(select(.environment == "DEV")) | sort_by(.created) | reverse | .[0].created')
        echo "latest_dev_created=$LATEST_DEV_CREATED" >> $GITHUB_OUTPUT
        echo "Latest DEV release bundle created at: $LATEST_DEV_CREATED"
    
    - name: Promote to QA
      run: |
        LATEST_DEV_VERSION="${{ steps.get-latest-dev-version.outputs.latest_dev_version }}"
        
        echo "üöÄ Promoting release bundle quotopia version $LATEST_DEV_VERSION from DEV to QA..."
        
        # Promote the release bundle from DEV to QA
        jf release-bundle-promote quotopia $LATEST_DEV_VERSION QA
        
        if [ $? -eq 0 ]; then
          echo "‚úÖ Successfully promoted quotopia version $LATEST_DEV_VERSION to QA"
          
          # Create a link to the QA release bundle
          QA_LINK="${{ vars.JF_URL }}/ui/artifactory/lifecycle?bundleName=quotopia&releaseBundleVersion=$LATEST_DEV_VERSION&repositoryKey=release-bundles-v2&activeVersionTab=Evidence%20Graph"
          echo "üîó QA Release Bundle: [quotopia:$LATEST_DEV_VERSION]($QA_LINK)" >> $GITHUB_STEP_SUMMARY
        else
          echo "‚ùå Failed to promote quotopia version $LATEST_DEV_VERSION to QA"
          exit 1
        fi
