name: Create Application Version

on:
  workflow_dispatch:
  workflow_call:

permissions:
  actions: read           # for detecting the Github Actions environment
  id-token: write         # for creating OIDC tokens for signing
  packages: write         # for uploading attestations
  contents: read          # read the contents permission
  security-events: write  # for uploading code scanning

jobs:
  create-application-version:
    name: Create Application Version
    runs-on: ubuntu-latest
    env:
      JF_URL: ${{ vars.JF_URL }}
      # JF_USER: ${{ vars.JF_USER }}
      # JF_ACCESS_TOKEN: ${{ secrets.JF_ACCESS_TOKEN }}
      APP_ID: ${{ vars.APPLICATION_NAME }}
      JFROG_CLI_KEY_ALIAS: ${{ vars.JFROG_CLI_KEY_ALIAS }}
      JFROG_CLI_SIGNING_KEY: ${{ secrets.JFROG_CLI_SIGNING_KEY }}
      JF_PROJECT: ${{ vars.JF_PROJECT }}
      SOURCE_BUILD_NAME_BACKEND: "btcwallet"
      SOURCE_BUILD_NAME_FRONTEND: "btcwallet-ui"
      SOURCE_BUILD_NAME_SERVICE: "ai-translate"

    steps:
      - name: Setup JFrog CLI
        uses: jfrog/setup-jfrog-cli@v4
        with:
          version: latest
          oidc-provider-name: btcwallet-gh
          oidc-audience: btcwallet-gh
        id: setup-cli
        env:
          JF_URL: ${{ vars.JF_URL }}
          # JF_USER: ${{ vars.JF_USER }}
          # JF_ACCESS_TOKEN: ${{ secrets.JF_ACCESS_TOKEN }}
          JF_PROJECT: ${{ env.JF_PROJECT }}

      - name: Get latest services build numbers
        id: get-latest-builds
        run: |
          set +e
          getBuildNumber() {
            echo "Requeseting build ${{ vars.JF_URL }}/artifactory/api/build/$1?project=${{ env.JF_PROJECT }}" >&2
            local RESPONSE=$(curl -s -X GET \
                                -H "Authorization: Bearer ${{ steps.setup-cli.outputs.oidc-token }}" \
                                "${{ vars.JF_URL }}/artifactory/api/build/$1?project=${{ env.JF_PROJECT }}")
            local LATEST_BUILD_NUMBER=$(echo "$RESPONSE" | \
                                jq -r '.buildsNumbers | sort_by(.started) | reverse | .[0].uri | ltrimstr("/")')
            if [ "" == "$LATEST_BUILD_NUMBER" ]; then 
                echo "Failed to parse latest build number for build '$1' from response: $RESPONSE" >&2
                exit 1
            fi
            echo "$LATEST_BUILD_NUMBER"
          }

          # Fetch build information from Artifactory API
          LATEST_BTCWALLET_BUILD_NUMBER=$(getBuildNumber ${{ env.SOURCE_BUILD_NAME_BACKEND }})
          [ $? -ne 0 ] && echo "$LATEST_BTCWALLET_BUILD_NUMBER" && exit 1

          echo "latest_btcwallet_build_number=$LATEST_BTCWALLET_BUILD_NUMBER" >> $GITHUB_OUTPUT
          echo "Found latest ${{ env.SOURCE_BUILD_NAME_BACKEND }} build number: $LATEST_BTCWALLET_BUILD_NUMBER"

          LATEST_BTCWALLET_UI_BUILD_NUMBER=$(getBuildNumber ${{ env.SOURCE_BUILD_NAME_FRONTEND }})
          [ $? -ne 0 ] && echo "$LATEST_BTCWALLET_UI_BUILD_NUMBER" && exit 1

          echo "latest_btcwallet_ui_build_number=$LATEST_BTCWALLET_UI_BUILD_NUMBER" >> $GITHUB_OUTPUT
          echo "Found latest ${{ env.SOURCE_BUILD_NAME_FRONTEND }} build number: $LATEST_BTCWALLET_UI_BUILD_NUMBER"

          LATEST_AI_TRANSLATE_BUILD_NUMBER=$(getBuildNumber ${{ env.SOURCE_BUILD_NAME_SERVICE }})
          [ $? -ne 0 ] && echo "$LATEST_AI_TRANSLATE_BUILD_NUMBER" && exit 1
          
          echo "latest_ai_translate_build_number=$LATEST_AI_TRANSLATE_BUILD_NUMBER" >> $GITHUB_OUTPUT
          echo "Found latest ${{ env.SOURCE_BUILD_NAME_SERVICE }} build number: $LATEST_AI_TRANSLATE_BUILD_NUMBER"

      - name: Get latest application version
        id: get_app_ver
        run: |
          # Define a temporary file to store the API response body
          RESPONSE_BODY_FILE=$(mktemp)

          # Use the API to get the latest version.
          # We use limit=1 and order_by=created to get the most recent version.
          API_URL="$JF_URL/apptrust/api/v1/applications/$APP_ID/versions?order_by=created&limit=1"

          echo "Fetching latest application version from: $API_URL"

          # Use curl to get the HTTP status code and save the body to a temp file.
          HTTP_CODE=$(curl -sS -o "$RESPONSE_BODY_FILE" -w "%{http_code}" \
            -H "Authorization: Bearer ${{ steps.setup-cli.outputs.oidc-token }}" \
            "$API_URL")

          echo "HTTP Response Code: $HTTP_CODE"

          # Check if the API call was successful (200, 201, 202)
          if [[ "$HTTP_CODE" =~ ^(200|201|202)$ ]]; then
            # Read the JSON response from the temp file.
            RESPONSE_BODY=$(cat "$RESPONSE_BODY_FILE")
            
            # Use jq to parse the JSON and extract the version.
            LATEST_VER=$(echo "$RESPONSE_BODY" | jq -r '.versions[0].version')
            
            # Check if the extracted version is null or empty.
            if [ "$LATEST_VER" == "null" ] || [ -z "$LATEST_VER" ]; then
              echo "API call was successful, but no version found. Setting version to 0."
              LATEST_VER="0"
            else
              echo "Found latest application version: $LATEST_VER"
            fi
          else
            echo "Error: API call failed with HTTP status code $HTTP_CODE."
            echo "Response body from temp file:"
            cat "$RESPONSE_BODY_FILE"
            rm "$RESPONSE_BODY_FILE" # Clean up temp file on failure
            exit 1
          fi

          # Clean up the temporary file
          rm "$RESPONSE_BODY_FILE"

          echo "app_ver=$LATEST_VER" >> $GITHUB_OUTPUT

      - name: Create an application version
        id: create_app_ver
        run: |
          set +e
          BTCWALLET_BUILD_NUMBER="${{ steps.get-latest-builds.outputs.latest_btcwallet_build_number }}"
          BTCWALLET_UI_BUILD_NUMBER="${{ steps.get-latest-builds.outputs.latest_btcwallet_ui_build_number }}"
          AI_TRANSLATE_BUILD_NUMBER="${{ steps.get-latest-builds.outputs.latest_ai_translate_build_number }}"
  
          echo "APP_ID=$APP_ID"
          LATEST_VER="${{ steps.get_app_ver.outputs.app_ver }}"
          NEXT_VER=$((LATEST_VER + 1))
          echo "LATEST_VER=$LATEST_VER"
          echo "NEXT_VER=$NEXT_VER"
  
          REQUEST_BODY="{\"version\": \"$NEXT_VER\", \"sources\": {\"builds\": [\
          {\"name\":\"${{ env.SOURCE_BUILD_NAME_BACKEND }}\", \"number\":\"$BTCWALLET_BUILD_NUMBER\", \"repository_key\":\"${{ env.JF_PROJECT }}-build-info\", \"include_dependencies\":false},\
          {\"name\":\"${{ env.SOURCE_BUILD_NAME_FRONTEND }}\", \"number\":\"$BTCWALLET_UI_BUILD_NUMBER\", \"repository_key\":\"${{ env.JF_PROJECT }}-build-info\", \"include_dependencies\":false},\
          {\"name\":\"${{ env.SOURCE_BUILD_NAME_SERVICE }}\", \"number\":\"$AI_TRANSLATE_BUILD_NUMBER\", \"repository_key\":\"${{ env.JF_PROJECT }}-build-info\", \"include_dependencies\":false}\
          ]}}"
          echo "REQUEST_BODY=$REQUEST_BODY"

          # #region agent log
          echo "ðŸ” [DEBUG] Creating application version - Hypothesis C"
          echo "  APP_ID: $APP_ID"
          echo "  Version: $NEXT_VER"
          echo "  Builds: btcwallet=$BTCWALLET_BUILD_NUMBER, btcwallet-ui=$BTCWALLET_UI_BUILD_NUMBER, ai-translate=$AI_TRANSLATE_BUILD_NUMBER"
          echo "{\"timestamp\":$(date +%s000),\"location\":\"create-application-version.yml:150\",\"message\":\"Creating application version\",\"data\":{\"app_id\":\"$APP_ID\",\"version\":\"$NEXT_VER\",\"builds\":[{\"name\":\"${{ env.SOURCE_BUILD_NAME_BACKEND }}\",\"number\":\"$BTCWALLET_BUILD_NUMBER\"},{\"name\":\"${{ env.SOURCE_BUILD_NAME_FRONTEND }}\",\"number\":\"$BTCWALLET_UI_BUILD_NUMBER\"},{\"name\":\"${{ env.SOURCE_BUILD_NAME_SERVICE }}\",\"number\":\"$AI_TRANSLATE_BUILD_NUMBER\"}]},\"sessionId\":\"debug-session\",\"runId\":\"run1\",\"hypothesisId\":\"C\"}" | tee -a $GITHUB_WORKSPACE/.cursor/debug.log 2>/dev/null || true
          # #endregion

          RESPONSE_FILE=$(mktemp)
          STATUS_CODE=$(curl -o "$RESPONSE_FILE" -s -w "%{http_code}" -X POST -H "Authorization: Bearer ${{ steps.setup-cli.outputs.oidc-token }}" -d "$REQUEST_BODY" "$JF_URL/apptrust/api/v1/applications/$APP_ID/versions?async=false")
          echo "STATUS_CODE=$STATUS_CODE"
          
          # #region agent log
          echo "ðŸ” [DEBUG] Application version creation response - Hypothesis C"
          echo "  Status Code: $STATUS_CODE"
          echo "  Response: $(cat $RESPONSE_FILE | head -c 500)"
          echo "{\"timestamp\":$(date +%s000),\"location\":\"create-application-version.yml:158\",\"message\":\"Application version creation response\",\"data\":{\"status_code\":\"$STATUS_CODE\",\"response\":\"$(cat $RESPONSE_FILE | head -c 500 | jq -c . 2>/dev/null || cat $RESPONSE_FILE | head -c 500)\"},\"sessionId\":\"debug-session\",\"runId\":\"run1\",\"hypothesisId\":\"C\"}" | tee -a $GITHUB_WORKSPACE/.cursor/debug.log 2>/dev/null || true
          # #endregion
          
          if [ "201" != "$STATUS_CODE" ]; then 
              echo "Status code is not 201: $STATUS_CODE"
              echo "Response body:"
              cat "$RESPONSE_FILE"
              rm "$RESPONSE_FILE"
              exit 1
          fi
          
          # Fetch created version details to understand what artifacts/repositories are associated
          VERSION_DETAILS=$(curl -s -X GET -H "Authorization: Bearer ${{ steps.setup-cli.outputs.oidc-token }}" "$JF_URL/apptrust/api/v1/applications/$APP_ID/versions/$NEXT_VER")
          
          # #region agent log
          echo "ðŸ” [DEBUG] Application version details - Hypothesis B,C"
          echo "  Version: $NEXT_VER"
          echo "  Details: $(echo $VERSION_DETAILS | jq -c . 2>/dev/null | head -c 1000 || echo $VERSION_DETAILS | head -c 1000)"
          echo "{\"timestamp\":$(date +%s000),\"location\":\"create-application-version.yml:170\",\"message\":\"Application version details\",\"data\":{\"version\":\"$NEXT_VER\",\"details\":\"$(echo $VERSION_DETAILS | jq -c . 2>/dev/null | head -c 1000 || echo $VERSION_DETAILS | head -c 1000)\"},\"sessionId\":\"debug-session\",\"runId\":\"run1\",\"hypothesisId\":\"B,C\"}" | tee -a $GITHUB_WORKSPACE/.cursor/debug.log 2>/dev/null || true
          # #endregion
          
          rm "$RESPONSE_FILE"
          echo "app_ver=$NEXT_VER" >> $GITHUB_OUTPUT

      - name: Promote application to DEV
        run: |
          APP_VER=${{ steps.create_app_ver.outputs.app_ver }}
          REQUEST_BODY="{\"target_stage\":\"DEV\"}"
          REQUEST_URL="$JF_URL/apptrust/api/v1/applications/$APP_ID/versions/$APP_VER/promote?async=false"
          
          echo "APP_VER=$APP_VER"
          echo "APP_ID=$APP_ID"
          echo "REQUEST_BODY: $REQUEST_BODY"
          echo "REQUEST_URL: $REQUEST_URL"

          # #region agent log
          echo "ðŸ” [DEBUG] Promotion request details - Hypothesis A,D"
          echo "  APP_ID: $APP_ID"
          echo "  Version: $APP_VER"
          echo "  Target Stage: DEV"
          echo "  Request Body: $REQUEST_BODY"
          echo "{\"timestamp\":$(date +%s000),\"location\":\"create-application-version.yml:185\",\"message\":\"Promotion request details\",\"data\":{\"app_id\":\"$APP_ID\",\"version\":\"$APP_VER\",\"target_stage\":\"DEV\",\"request_body\":\"$REQUEST_BODY\"},\"sessionId\":\"debug-session\",\"runId\":\"run1\",\"hypothesisId\":\"A,D\"}" | tee -a $GITHUB_WORKSPACE/.cursor/debug.log 2>/dev/null || true
          # #endregion

          RESPONSE_FILE=$(mktemp)
          STATUS_CODE=$(curl -o "$RESPONSE_FILE" -s -w "%{http_code}" -X POST -H "Authorization: Bearer ${{ steps.setup-cli.outputs.oidc-token }}" -d "$REQUEST_BODY" "$REQUEST_URL")
          echo "STATUS_CODE=$STATUS_CODE"
          
          # #region agent log
          echo "ðŸ” [DEBUG] Promotion response - Hypothesis A,B,C,D,E"
          echo "  Status Code: $STATUS_CODE"
          echo "  Full Response: $(cat $RESPONSE_FILE)"
          echo "{\"timestamp\":$(date +%s000),\"location\":\"create-application-version.yml:192\",\"message\":\"Promotion response\",\"data\":{\"status_code\":\"$STATUS_CODE\",\"response\":\"$(cat $RESPONSE_FILE | jq -c . 2>/dev/null || cat $RESPONSE_FILE)\"},\"sessionId\":\"debug-session\",\"runId\":\"run1\",\"hypothesisId\":\"A,B,C,D,E\"}" | tee -a $GITHUB_WORKSPACE/.cursor/debug.log 2>/dev/null || true
          # #endregion
          
          if [ "200" != "$STATUS_CODE" -a "201" != "$STATUS_CODE" ]; then 
              echo "Status code is not 200 or 201: $STATUS_CODE"
              echo "Response body:"
              cat "$RESPONSE_FILE"
              
              # Try to get application and stage configuration details
              echo "ðŸ” [DEBUG] Fetching application configuration - Hypothesis B"
              APP_DETAILS=$(curl -s -X GET -H "Authorization: Bearer ${{ steps.setup-cli.outputs.oidc-token }}" "$JF_URL/apptrust/api/v1/applications/$APP_ID")
              echo "  Application Details:"
              echo "$APP_DETAILS" | jq . 2>/dev/null || echo "$APP_DETAILS"
              
              # Get stage configuration for DEV
              echo "ðŸ” [DEBUG] Fetching DEV stage configuration - Hypothesis B"
              STAGE_DETAILS=$(curl -s -X GET -H "Authorization: Bearer ${{ steps.setup-cli.outputs.oidc-token }}" "$JF_URL/apptrust/api/v1/applications/$APP_ID/stages/DEV" 2>/dev/null || echo "{\"error\":\"Could not fetch stage details\"}")
              echo "  DEV Stage Details:"
              echo "$STAGE_DETAILS" | jq . 2>/dev/null || echo "$STAGE_DETAILS"
              
              # #region agent log
              echo "ðŸ” [DEBUG] Application and stage details after promotion failure - Hypothesis B"
              echo "  App Details: $(echo $APP_DETAILS | jq -c . 2>/dev/null | head -c 1000 || echo $APP_DETAILS | head -c 1000)"
              echo "  Stage Details: $(echo $STAGE_DETAILS | jq -c . 2>/dev/null | head -c 1000 || echo $STAGE_DETAILS | head -c 1000)"
              echo "{\"timestamp\":$(date +%s000),\"location\":\"create-application-version.yml:202\",\"message\":\"Application details after promotion failure\",\"data\":{\"app_details\":\"$(echo $APP_DETAILS | jq -c . 2>/dev/null | head -c 1000 || echo $APP_DETAILS | head -c 1000)\",\"stage_details\":\"$(echo $STAGE_DETAILS | jq -c . 2>/dev/null | head -c 1000 || echo $STAGE_DETAILS | head -c 1000)\"},\"sessionId\":\"debug-session\",\"runId\":\"run1\",\"hypothesisId\":\"B\"}" | tee -a $GITHUB_WORKSPACE/.cursor/debug.log 2>/dev/null || true
              # #endregion
              
              rm "$RESPONSE_FILE"
              exit 1
          fi
          rm "$RESPONSE_FILE"
          echo "Successfully promoted $APP_ID version $APP_VER to DEV"
