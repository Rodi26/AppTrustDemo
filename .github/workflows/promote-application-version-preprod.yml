name: Promote Application to PreProd

on:
  workflow_dispatch:
  workflow_call:

permissions:
  actions: read           # for detecting the Github Actions environment
  id-token: write         # for creating OIDC tokens for signing
  packages: write         # for uploading attestations
  contents: read          # read the contents permission
  security-events: write  # for uploading code scanning

jobs:
  promote-application:
    name: Promote Latest Application Version to PreProd
    runs-on: ubuntu-latest
    env:
      JF_URL: ${{ vars.JF_URL }}
      JF_USER: ${{ vars.JF_USER }}
      JF_ACCESS_TOKEN: ${{ secrets.JF_ACCESS_TOKEN }}
      APP_ID: ${{ vars.APPLICATION_NAME }}
      TARGET_STAGE: ${{ vars.PREPROD_STAGE }}
      JFROG_CLI_KEY_ALIAS: ${{ vars.JFROG_CLI_KEY_ALIAS }}
      JFROG_CLI_SIGNING_KEY: ${{ secrets.JFROG_CLI_SIGNING_KEY }}
      # DOCKER_REGISTRY: ${{ vars.DOCKER_QA_REGISTRY }}
      JF_PROJECT: ${{ vars.JF_PROJECT }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup JFrog CLI
        uses: jfrog/setup-jfrog-cli@v4
        with:
          version: 2.82.0
          oidc-provider-name: btcwallet-gh
          oidc-audience: btcwallet-gh
        id: setup-cli
        env:
          JF_URL: ${{ vars.JF_URL }}
          # JF_USER: ${{ vars.JF_USER }}
          # JF_ACCESS_TOKEN: ${{ secrets.JF_ACCESS_TOKEN }}
          
      - name: Get latest application version
        id: get_app_ver
        run: |
          # Use the API to get the latest version.
          # We use limit=1 and order_by=created to get the most recent version.
          API_URL="$JF_URL/apptrust/api/v1/applications/$APP_ID/versions?order_by=created&limit=1"
          
          echo "Fetching latest application version from: $API_URL"
          
          RESPONSE=$(curl -s -X GET \
            -H "Authorization: Bearer $JF_ACCESS_TOKEN" \
            "$API_URL")
          
          # Use jq to parse the JSON and extract the version.
          # The API returns an array 'versions', so we get the first element.
          LATEST_VER=$(echo "$RESPONSE" | jq -r '.versions[0].version')
          
          if [ "$LATEST_VER" == "null" ] || [ -z "$LATEST_VER" ]; then
            echo "Error: Could not retrieve a valid application version."
            exit 1
          fi
          
          echo "Found latest application version: $LATEST_VER"
          echo "app_ver=$LATEST_VER" >> $GITHUB_OUTPUT

      - name: Promote application to ${{ env.TARGET_STAGE }}
        id: promote_step
        run: |
          APP_VER=${{ steps.get_app_ver.outputs.app_ver }}
          REQUEST_BODY="{\"target_stage\":\"$TARGET_STAGE\"}"
          
          PROMOTION_URL="$JF_URL/apptrust/api/v1/applications/$APP_ID/versions/$APP_VER/promote"
          echo "Promoting application '$APP_ID' version $APP_VER to stage $TARGET_STAGE..."
          
          STATUS_CODE=$(curl -s -o /dev/null -w "%{http_code}" -X POST \
            -H "Authorization: Bearer $JF_ACCESS_TOKEN" \
            -H "Content-Type: application/json" \
            -d "$REQUEST_BODY" \
            "$PROMOTION_URL")
          
          echo "Promotion request returned status code: $STATUS_CODE"
          
          # The API returns 200, 201, or 202 on success, depending on the promotion process.
          if [[ "$STATUS_CODE" -ge 200 && "$STATUS_CODE" -le 202 ]]; then
            echo "Successfully promoted $APP_ID version $APP_VER to $TARGET_STAGE."
          else
            echo "Failed to promote application. HTTP status code: $STATUS_CODE"
            # Run again to see output
            curl -s -X POST -H "Authorization: Bearer $JF_ACCESS_TOKEN" -H "Content-Type: application/json" -d "$REQUEST_BODY" "$PROMOTION_URL"
            exit 1
          fi

      - name: Create gate certification evidence for ${{ env.TARGET_STAGE }} stage
        run: |
          echo "ğŸ“‹ Creating gate certification evidence for ${{ env.TARGET_STAGE }} stage..."
          APP_VER=${{ steps.get_app_ver.outputs.app_ver }}
          STAGE="${{ env.TARGET_STAGE }}"
          TIMESTAMP=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          
          # Create predicate JSON
          cat > gate-certify-predicate.json <<EOF
          {
            "application_key": "${{ env.APP_ID }}",
            "application_name": "BTC Wallet App",
            "stage": "$STAGE",
            "gate": "exit",
            "status": "certified",
            "timestamp": "$TIMESTAMP"
          }
          EOF
          
          # Create markdown documentation
          cat > gate-certify.md <<EOF
          # Gate Certification Evidence - $STAGE Stage
          
          - **Stage**: $STAGE
          - **Gate Type**: exit
          - **Status**: certified
          - **Timestamp**: $TIMESTAMP
          - **Application**: ${{ env.APP_ID }}
          - **Version**: $APP_VER
          EOF
          
          jf evd create \
              --application-key "${{ env.APP_ID }}" \
              --application-version "$APP_VER" \
              --predicate gate-certify-predicate.json \
              --predicate-type https://jfrog.com/evidence/apptrust/gate-certify/v1 \
              --markdown gate-certify.md \
              --provider-id apptrust
                   
          echo "âœ… Gate certification evidence created successfully for $STAGE stage"
          
          # Write evidence path to attestation paths file for automatic evidence collection
          EVIDENCE_PATH="${{ env.JF_PROJECT }}-application-versions/${{ env.APP_ID }}/$APP_VER/release-bundle.json.evd"
          ATTESTATION_PATHS_FILE="/home/runner/work/_temp/created_attestation_paths.txt"
          mkdir -p "$(dirname "$ATTESTATION_PATHS_FILE")"
          echo "$EVIDENCE_PATH" >> "$ATTESTATION_PATHS_FILE"
          echo "ğŸ“ Written evidence path to attestation paths file: $EVIDENCE_PATH"

      - name: Create evidence for Release Approval (simulate SNOW)
        run: |
          echo "ğŸ“‹ Creating evidence for Release Approval (SNOW)..."
          cd snow

          EVIDENCE_PATH="${{ env.JF_PROJECT }}-application-versions/${{ env.APP_ID }}/${{ steps.get_app_ver.outputs.app_ver }}/release-bundle.json.evd"
          
          jf evd create \
              --subject-repo-path="$EVIDENCE_PATH" \
              --project ${{ env.JF_PROJECT }} \
              --predicate approval.json \
              --predicate-type https://servicenow.com/approval/v1 \
              --markdown approval.md \
              --provider-id servicenow
                   
          echo "âœ… Evidence created successfully"
          
          # Write evidence path to attestation paths file for automatic evidence collection
          ATTESTATION_PATHS_FILE="/home/runner/work/_temp/created_attestation_paths.txt"
          mkdir -p "$(dirname "$ATTESTATION_PATHS_FILE")"
          echo "$EVIDENCE_PATH" >> "$ATTESTATION_PATHS_FILE"
          echo "ğŸ“ Written evidence path to attestation paths file: $EVIDENCE_PATH"